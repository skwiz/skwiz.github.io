define("discourse/plugins/discourse-whos-online/discourse/components/whos-online-avatar",["exports","ember"],(function(e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var n=s.default.Component.extend({tagName:"a",attributeBindings:["user.username:data-user-card","user.path:href"]});e.default=n})),define("discourse/plugins/discourse-whos-online/discourse/components/whos-online",["exports","ember"],(function(e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var n=s.default.inject,i=s.default.Component.extend({showWhosOnline:function(){return!(this.get("online").users.length<this.siteSettings.whos_online_minimum_display&&this.siteSettings.whos_online_hide_below_minimum_display)&&this.get("online").get("shouldDisplay")}.property(),online:n.service("online-service"),users:function(){return this.get("online").users.slice(0,this.siteSettings.whos_online_maximum_display)}.property("online.users.@each"),isLong:function(){return this.get("online").users.length>=this.siteSettings.whos_online_collapse_threshold}.property("online.users.length"),isUsers:function(){return this.get("online").users.length>=this.siteSettings.whos_online_minimum_display}.property("online.users.length")});e.default=i})),define("discourse/plugins/discourse-whos-online/discourse/initializers/start-whos-online",["exports","discourse/lib/plugin-api","discourse-common/utils/decorators"],(function(e,s,n){"use strict";function i(e,s,n,i,t){var r={};return Object.keys(i).forEach((function(e){r[e]=i[e]})),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=n.slice().reverse().reduce((function(n,i){return i(e,s,n)||n}),r),t&&void 0!==r.initializer&&(r.value=r.initializer?r.initializer.call(t):void 0,r.initializer=void 0),void 0===r.initializer&&(Object.defineProperty(e,s,r),r=null),r}Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var t=Ember.inject,r={name:"start-whos-online",initialize:function(e){var r=e.lookup("service:online-service"),o=e.lookup("site-settings:main");if(r.get("shouldDisplay")){var a=o.whos_online_avatar_indicator;"none"!==a&&($("html").addClass("whos-online-".concat(a)),(0,s.withPluginApi)("0.2",(function(e){var s,a,l,u,c,d;(e.modifyClass("component:user-card-contents",(s=(0,n.default)("user","onlineService.users.@each"),i(a={onlineService:t.service("online-service"),classNameBindings:["isOnline:user-online"],isOnline:function(e){return!!e&&this.onlineService.isUserOnline(e.id)}},"isOnline",[s],Object.getOwnPropertyDescriptor(a,"isOnline"),a),a)),e.modifyClass("route:user",{onlineService:t.service("online-service"),afterModel:function(){return this.updateBodyClass(),this._super()},updateBodyClass:function(){var e=this.modelFor("user").id;this.get("onlineService").isUserOnline(e)?Ember.$("body").addClass("user-page-online"):Ember.$("body").removeClass("user-page-online")}.observes("onlineService.users.@each"),deactivate:function(){this._super(),Ember.$("body").removeClass("user-page-online")}}),o.whos_online_avatar_indicator_topic_lists)&&(e.modifyClass("component:topic-list-item",(l=(0,n.default)("topic.lastPoster.id","topic.lastPosterUser.id","onlineService.users.@each"),i(u={onlineService:t.service("online-service"),classNameBindings:["isOnline:last-poster-online"],isOnline:function(e,s){return this.get("onlineService").isUserOnline(e||s)}},"isOnline",[l],Object.getOwnPropertyDescriptor(u,"isOnline"),u),u)),e.modifyClass("component:latest-topic-list-item",(c=(0,n.default)("topic.lastPoster.id","topic.lastPosterUser.id","onlineService.users.@each"),i(d={onlineService:t.service("online-service"),classNameBindings:["isOnline:last-poster-online"],isOnline:function(e,s){return this.get("onlineService").isUserOnline(e||s)}},"isOnline",[c],Object.getOwnPropertyDescriptor(d,"isOnline"),d),d)));e.modifyClass("component:scrolling-post-stream",{didInsertElement:function(){var e=this;this._super(),this.appEvents.on("whosonline:changed",(function(s){s.forEach((function(s){e.get("attrs").posts.value.posts.filter((function(e){return e.user_id===s})).map((function(e){return e.id})).forEach((function(n){e.dirtyKeys.keyDirty("post-".concat(n)),e.dirtyKeys.keyDirty("post-".concat(n,"-avatar-").concat(s),{onRefresh:"updateOnline"})}))})),e.queueRerender()}))},willDestroyElement:function(){this.appEvents.off("whosonline:changed")}}),e.reopenWidget("post-avatar",{buildKey:function(e){return"post-".concat(e.id,"-avatar-").concat(e.user_id)},defaultState:function(e){return{online:r.isUserOnline(e.user_id)}},updateOnline:function(){this.state.online=r.isUserOnline(this.attrs.user_id)},buildClasses:function(e,s){return s.online?"user-online":[]}})})))}}};e.default=r})),define("discourse/plugins/discourse-whos-online/discourse/services/online-service",["exports","@ember/service","discourse/lib/ajax","discourse/models/user","discourse/models/site"],(function(e,s,n,i,t){"use strict";function r(e){return function(e){if(Array.isArray(e))return o(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e,s){if(!e)return;if("string"==typeof e)return o(e,s);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return o(e,s)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function o(e,s){(null==s||s>e.length)&&(s=e.length);for(var n=0,i=new Array(s);n<s;n++)i[n]=e[n];return i}Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var a=s.default.extend({after:"message-bus",messageBus:window.MessageBus,users:[],appEvents:Discourse.__container__.lookup("service:app-events"),siteSettings:Discourse.__container__.lookup("site-settings:main"),_lastMessageId:null,isUserOnline:function(e){return void 0!==this.get("users").find((function(e){return e.id===this}),e)},messageProcessor:function(){var e=this;return function(s,t,o){var a=e.get("users");if(o!==e.get("_lastMessageId")+1)return e.messageBus.unsubscribe("/whos-online",this.func),void(0,n.ajax)("/whosonline/get.json",{method:"GET"}).then((function(s){var n=a.map((function(e){return e.get("id")}));e.set("users",s.users.map((function(e){return i.default.create(e)})));var t=e.get("users").map((function(e){return e.get("id")}));e.set("_lastMessageId",s.messagebus_id),e.messageBus.subscribe("/whos-online",e.messageProcessor(),s.messagebus_id);var o=[].concat(r(n),r(t));e.appEvents.trigger("whosonline:changed",o)}),(function(e){console.log(e)}));switch(e.set("_lastMessageId",o),s.message_type){case"going_online":var l=i.default.create(s.user);a.pushObject(l),e.appEvents.trigger("whosonline:changed",[l.get("id")]);break;case"going_offline":var u=function(e){return e.get("id")===this};s.users.forEach((function(e){var s=a.find(u,e);void 0!==s&&a.removeObject(s)})),e.appEvents.trigger("whosonline:changed",s.users);break;default:console.error("Unknown message type sent to /whos-online")}}},init:function(){var e=t.default.currentProp("users_online");e&&(this.set("users",e.users.map((function(e){return i.default.create(e)}))),this.set("_lastMessageId",e.messagebus_id),this.appEvents.trigger("whosonline:changed",e.users.map((function(e){return e.id}))),this.messageBus.subscribe("/whos-online",this.messageProcessor(),e.messagebus_id)),this._super.apply(this,arguments)},shouldDisplay:function(){if(!this.siteSettings.whos_online_enabled)return!1;if(this.siteSettings.whos_online_display_public)return!0;var e=Discourse.User.current();return null!==e&&e.trust_level>=this.siteSettings.whos_online_display_min_trust_level}.property()});e.default=a})),Ember.TEMPLATES["javascripts/components/whos-online-avatar"]=Ember.HTMLBars.template({id:null,block:'{"symbols":[],"statements":[[1,[28,"avatar",[[24,["user"]]],[["avatarTemplatePath","title","imageSize"],["avatar_template",[24,["user","username"]],"small"]]],false],[0,"\\n"]],"hasEval":false}',meta:{moduleName:"javascripts/discourse/templates/components/whos-online-avatar"}}),Ember.TEMPLATES["javascripts/components/whos-online"]=Ember.HTMLBars.template({id:null,block:'{"symbols":["user"],"statements":[[4,"if",[[24,["showWhosOnline"]]],null,{"statements":[[0,"  "],[7,"div",true],[10,"id","whos-online"],[11,"class",[28,"if",[[24,["isLong"]],"collapsed"],null]],[8],[0,"\\n    "],[7,"span",true],[11,"title",[28,"i18n",["whos_online.tooltip"],null]],[8],[0,"\\n"],[4,"if",[[24,["isUsers"]]],null,{"statements":[[0,"        "],[1,[28,"i18n",["whos_online.title"],[["count"],[[24,["online","users","length"]]]]],false],[0,"\\n"]],"parameters":[]},{"statements":[[0,"        "],[1,[28,"i18n",["whos_online.no_users"],null],false],[0,"\\n"]],"parameters":[]}],[0,"    "],[9],[0,"\\n"],[4,"if",[[24,["isUsers"]]],null,{"statements":[[4,"each",[[24,["users"]]],null,{"statements":[[0,"        "],[1,[28,"whos-online-avatar",null,[["user"],[[23,1,[]]]]],false],[0,"\\n"]],"parameters":[1]},null]],"parameters":[]},null],[0,"  "],[9],[0,"\\n"]],"parameters":[]},null]],"hasEval":false}',meta:{moduleName:"javascripts/discourse/templates/components/whos-online"}}),Ember.TEMPLATES["javascripts/connectors/discovery-list-container-top/online_users_widget"]=Ember.HTMLBars.template({id:null,block:'{"symbols":[],"statements":[[1,[22,"whos-online"],false],[0,"\\n"]],"hasEval":false}',meta:{moduleName:"javascripts/discourse/templates/connectors/discovery-list-container-top/online_users_widget"}});
//# sourceMappingURL=/assets/plugins/discourse-whos-online-2a928cefb5b0ec62baa0c2cefce350cd94ebe309e403b4085e4841d2609a418b.js.map