define("discourse/plugins/discourse-whos-online/discourse/initializers/start-whos-online",["exports","discourse/lib/plugin-api","discourse-common/utils/decorators"],function(e,s,r){"use strict";function o(n,i,e,s,t){var r={};return Object.keys(s).forEach(function(e){r[e]=s[e]}),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=e.slice().reverse().reduce(function(e,s){return s(n,i,e)||e},r),t&&void 0!==r.initializer&&(r.value=r.initializer?r.initializer.call(t):void 0,r.initializer=void 0),void 0===r.initializer&&(Object.defineProperty(n,i,r),r=null),r}Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var a=Ember.inject,n={name:"start-whos-online",initialize:function(e){var i=e.lookup("service:online-service"),t=e.lookup("site-settings:main");!i.get("shouldDisplay")||"none"!==(e=t.whos_online_avatar_indicator)&&($("html").addClass("whos-online-".concat(e)),(0,s.withPluginApi)("0.2",function(e){var s,n;e.modifyClass("component:user-card-contents",(s=(0,r.default)("user","onlineService.users.@each"),o(n={onlineService:a.service("online-service"),classNameBindings:["isOnline:user-online"],isOnline:function(e){return!!e&&this.onlineService.isUserOnline(e.id)}},"isOnline",[s],Object.getOwnPropertyDescriptor(n,"isOnline"),n),n)),e.modifyClass("route:user",{onlineService:a.service("online-service"),afterModel:function(){return this.updateBodyClass(),this._super()},updateBodyClass:function(){var e=this.modelFor("user").id;this.get("onlineService").isUserOnline(e)?Ember.$("body").addClass("user-page-online"):Ember.$("body").removeClass("user-page-online")}.observes("onlineService.users.@each"),deactivate:function(){this._super(),Ember.$("body").removeClass("user-page-online")}}),t.whos_online_avatar_indicator_topic_lists&&(e.modifyClass("component:topic-list-item",(s=(0,r.default)("topic.lastPoster.id","topic.lastPosterUser.id","onlineService.users.@each"),o(n={onlineService:a.service("online-service"),classNameBindings:["isOnline:last-poster-online"],isOnline:function(e,s){return this.get("onlineService").isUserOnline(e||s)}},"isOnline",[s],Object.getOwnPropertyDescriptor(n,"isOnline"),n),n)),e.modifyClass("component:latest-topic-list-item",(s=(0,r.default)("topic.lastPoster.id","topic.lastPosterUser.id","onlineService.users.@each"),o(n={onlineService:a.service("online-service"),classNameBindings:["isOnline:last-poster-online"],isOnline:function(e,s){return this.get("onlineService").isUserOnline(e||s)}},"isOnline",[s],Object.getOwnPropertyDescriptor(n,"isOnline"),n),n))),e.modifyClass("component:scrolling-post-stream",{didInsertElement:function(){var n=this;this._super(),this.appEvents.on("whosonline:changed",function(e){e.forEach(function(s){n.get("attrs").posts.value.posts.filter(function(e){return e.user_id===s}).map(function(e){return e.id}).forEach(function(e){n.dirtyKeys.keyDirty("post-".concat(e)),n.dirtyKeys.keyDirty("post-".concat(e,"-avatar-").concat(s),{onRefresh:"updateOnline"})})}),n.queueRerender()})},willDestroyElement:function(){this.appEvents.off("whosonline:changed")}}),e.reopenWidget("post-avatar",{buildKey:function(e){return"post-".concat(e.id,"-avatar-").concat(e.user_id)},defaultState:function(e){return{online:i.isUserOnline(e.user_id)}},updateOnline:function(){this.state.online=i.isUserOnline(this.attrs.user_id)},buildClasses:function(e,s){return s.online?"user-online":[]}})}))}};e.default=n}),define("discourse/plugins/discourse-whos-online/discourse/services/online-service",["exports","ember","discourse/lib/ajax","discourse/models/user","discourse/models/site"],function(e,s,a,l,n){"use strict";function u(e){return function(e){if(Array.isArray(e))return i(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e,s){if(!e)return;if("string"==typeof e)return i(e,s);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return i(e,s)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function i(e,s){(null==s||s>e.length)&&(s=e.length);for(var n=0,i=new Array(s);n<s;n++)i[n]=e[n];return i}Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;s=s.default.Service.extend({after:"message-bus",messageBus:window.MessageBus,users:[],appEvents:Discourse.__container__.lookup("service:app-events"),siteSettings:Discourse.__container__.lookup("site-settings:main"),_lastMessageId:null,isUserOnline:function(e){return void 0!==this.get("users").find(function(e){return e.id===this},e)},messageProcessor:function(){var o=this;return function(e,s,n){var i=o.get("users");if(n!==o.get("_lastMessageId")+1)return o.messageBus.unsubscribe("/whos-online",this.func),void(0,a.ajax)("/whosonline/get.json",{method:"GET"}).then(function(e){var s=i.map(function(e){return e.get("id")});o.set("users",e.users.map(function(e){return l.default.create(e)}));var n=o.get("users").map(function(e){return e.get("id")});o.set("_lastMessageId",e.messagebus_id),o.messageBus.subscribe("/whos-online",o.messageProcessor(),e.messagebus_id);n=[].concat(u(s),u(n));o.appEvents.trigger("whosonline:changed",n)},function(e){console.log(e)});switch(o.set("_lastMessageId",n),e.message_type){case"going_online":var t=l.default.create(e.user);i.pushObject(t),o.appEvents.trigger("whosonline:changed",[t.get("id")]);break;case"going_offline":var r=function(e){return e.get("id")===this};e.users.forEach(function(e){e=i.find(r,e);void 0!==e&&i.removeObject(e)}),o.appEvents.trigger("whosonline:changed",e.users);break;default:console.error("Unknown message type sent to /whos-online")}}},init:function(){var e=n.default.currentProp("users_online");e&&(this.set("users",e.users.map(function(e){return l.default.create(e)})),this.set("_lastMessageId",e.messagebus_id),this.appEvents.trigger("whosonline:changed",e.users.map(function(e){return e.id})),this.messageBus.subscribe("/whos-online",this.messageProcessor(),e.messagebus_id)),this._super.apply(this,arguments)},shouldDisplay:function(){if(!this.siteSettings.whos_online_enabled)return!1;if(this.siteSettings.whos_online_display_public)return!0;var e=Discourse.User.current();return null!==e&&e.trust_level>=this.siteSettings.whos_online_display_min_trust_level}.property()});e.default=s}),define("discourse/plugins/discourse-whos-online/discourse/components/whos-online-avatar",["exports","ember"],function(e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;s=s.default.Component.extend({tagName:"a",attributeBindings:["user.username:data-user-card","user.path:href"]});e.default=s}),define("discourse/plugins/discourse-whos-online/discourse/components/whos-online",["exports","ember"],function(e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var n=s.default.inject,n=s.default.Component.extend({showWhosOnline:function(){return!(this.get("online").users.length<this.siteSettings.whos_online_minimum_display&&this.siteSettings.whos_online_hide_below_minimum_display)&&this.get("online").get("shouldDisplay")}.property(),online:n.service("online-service"),users:function(){return this.get("online").users.slice(0,this.siteSettings.whos_online_maximum_display)}.property("online.users.@each"),isLong:function(){return this.get("online").users.length>=this.siteSettings.whos_online_collapse_threshold}.property("online.users.length"),isUsers:function(){return this.get("online").users.length>=this.siteSettings.whos_online_minimum_display}.property("online.users.length")});e.default=n}),Ember.TEMPLATES["javascripts/connectors/discovery-list-container-top/online_users_widget"]=Ember.HTMLBars.template({id:null,block:'{"symbols":[],"statements":[[1,[22,"whos-online"],false],[0,"\\n"]],"hasEval":false}',meta:{moduleName:"javascripts/discourse/templates/connectors/discovery-list-container-top/online_users_widget"}}),Ember.TEMPLATES["javascripts/components/whos-online"]=Ember.HTMLBars.template({id:null,block:'{"symbols":["user"],"statements":[[4,"if",[[24,["showWhosOnline"]]],null,{"statements":[[0,"  "],[7,"div",true],[10,"id","whos-online"],[11,"class",[28,"if",[[24,["isLong"]],"collapsed"],null]],[8],[0,"\\n    "],[7,"span",true],[11,"title",[28,"i18n",["whos_online.tooltip"],null]],[8],[0,"\\n"],[4,"if",[[24,["isUsers"]]],null,{"statements":[[0,"        "],[1,[28,"i18n",["whos_online.title"],[["count"],[[24,["online","users","length"]]]]],false],[0,"\\n"]],"parameters":[]},{"statements":[[0,"        "],[1,[28,"i18n",["whos_online.no_users"],null],false],[0,"\\n"]],"parameters":[]}],[0,"    "],[9],[0,"\\n"],[4,"if",[[24,["isUsers"]]],null,{"statements":[[4,"each",[[24,["users"]]],null,{"statements":[[0,"        "],[1,[28,"whos-online-avatar",null,[["user"],[[23,1,[]]]]],false],[0,"\\n"]],"parameters":[1]},null]],"parameters":[]},null],[0,"  "],[9],[0,"\\n"]],"parameters":[]},null]],"hasEval":false}',meta:{moduleName:"javascripts/discourse/templates/components/whos-online"}}),Ember.TEMPLATES["javascripts/components/whos-online-avatar"]=Ember.HTMLBars.template({id:null,block:'{"symbols":[],"statements":[[1,[28,"avatar",[[24,["user"]]],[["avatarTemplatePath","title","imageSize"],["avatar_template",[24,["user","username"]],"small"]]],false],[0,"\\n"]],"hasEval":false}',meta:{moduleName:"javascripts/discourse/templates/components/whos-online-avatar"}});
//# sourceMappingURL=/assets/plugins/discourse-whos-online-83638c409ed39e0fc8c7744e7a1b5637bf2e32419bf1bf3792d88fe6ec657a51.js.map